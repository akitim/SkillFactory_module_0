-- ====================================================================
---------------------------Задание 4.2---------------------------------
-- В большинстве городов есть только один аэропорт. Исключение составляет:

-- SELECT a.city,
--       count(a.airport_code)
-- FROM dst_project.airports a
-- GROUP BY 1
-- HAVING count(a.airport_code) > 1

-- ====================================================================
---------------------------Задание 4.2---------------------------------
-----------------------------Вопрос 1----------------------------------
-- Сколько всего статусов для рейсов определено в таблице?

-- SELECT count (distinct f.status)
-- from dst_project.flights f

-----------------------------Вопрос 2----------------------------------
-- Какое количество самолетов находятся в воздухе на момент среза в базе?

-- SELECT COUNT (f.status)
-- FROM dst_project.flights f
-- WHERE f.status in ('Departed')

-----------------------------Вопрос 3----------------------------------
-- Сколько мест имеет самолет модели  (Boeing 777-300)?

-- SELECT count(s.seat_no) Num_of_seats_in_Boeing_773
-- FROM dst_project.seats s
-- LEFT JOIN dst_project.aircrafts a ON s.aircraft_code=a.aircraft_code
-- WHERE a.model = 'Boeing 777-300'

    
-----------------------------Вопрос 4----------------------------------
--  Сколько состоявшихся (фактических) рейсов было совершено между 1 апреля 2017 года и 1 сентября 2017 года?

-- SELECT count(f.flight_id) num_of_flights
-- FROM dst_project.flights f
-- WHERE f.status != 'Cancelled'
--   AND f.actual_arrival BETWEEN '04-01-2017, 00:00'::TIMESTAMP AND '09-01-2017, 00:00'::TIMESTAMP
-- ====================================================================
---------------------------Задание 4.3---------------------------------
-- Вопрос 1. Сколько всего рейсов было отменено по данным базы?

-- SELECT count(f.flight_id)
-- FROM dst_project.flights f
-- WHERE f.status = 'Cancelled'

-- Вопрос 2. Сколько самолетов моделей типа Boeing, Sukhoi Superjet, Airbus находится в базе авиаперевозок?

-- SELECT 'Boeing' aircraft_type,
--                 count(a.model) number
-- FROM dst_project.aircrafts a
-- WHERE a.model like '%Boeing%'
-- UNION ALL
-- SELECT 'Sukhoi Superjet' aircraft_type,
--                          count(a.model) number
-- FROM dst_project.aircrafts a
-- WHERE a.model like '%Sukhoi Superjet%'
-- UNION ALL
-- SELECT 'Airbus' aircraft_type,
--                 count(a.model) number
-- FROM dst_project.aircrafts a
-- WHERE a.model like '%Airbus%'

-- Вопрос 3. В какой части (частях) света находится больше аэропортов?

-- SELECT 'Europe' world_part,
--                 count(ap.airport_code)
-- FROM dst_project.airports ap
-- WHERE ap.timezone like '%Europe%'
-- UNION ALL
-- SELECT 'Asia' world_part,
--               count(ap.airport_code)
-- FROM dst_project.airports ap
-- WHERE ap.timezone like '%Asia%'

-- Вопрос 4. У какого рейса была самая большая задержка прибытия за все время сбора данных? Введите id рейса (flight_id).

--   SELECT f.flight_id,
--          extract(MINUTE
--                  FROM (f.actual_arrival - f.scheduled_arrival)) --arrival_delay
-- FROM dst_project.flights f
-- ORDER BY 2 DESC WITH arrival_delay AS
--   (SELECT f.flight_id,
--           extract(DAY
--                   FROM f.actual_arrival - f.scheduled_arrival)::real*24 + extract(HOUR
--                                                                                   FROM f.actual_arrival - f.scheduled_arrival)::real + extract(MINUTE
--                                                                                                                                               FROM f.actual_arrival - f.scheduled_arrival)::real/60 arrival_delay_in_hours
--   FROM dst_project.flights f)

-- SELECT ad.flight_id
-- FROM arrival_delay ad
-- WHERE ad.arrival_delay_in_hours IS NOT NULL
-- ORDER BY ad.arrival_delay_in_hours DESC
-- LIMIT 1

-- ====================================================================
---------------------------Задание 4.4---------------------------------
-- Вопрос 1.  Когда был запланирован самый первый вылет, сохраненный в базе данных?

-- SELECT min(f.scheduled_departure) first_flight_scheduled
-- FROM dst_project.flights f

-- Вопрос 2. Сколько минут составляет запланированное время полета в самом длительном рейсе?

-- SELECT extract(HOUR
--               FROM (f.scheduled_arrival - f.scheduled_departure))::real*60 + extract(MINUTE
--                                                                                       FROM (f.scheduled_arrival - f.scheduled_departure))::real scheduled_flight_time,
--       extract(HOUR
--               FROM (f.actual_arrival - f.actual_departure))::real*60 + extract(MINUTE
--                                                                                 FROM (f.actual_arrival - f.actual_departure))::real actual_flight_time
-- FROM dst_project.flights f
-- WHERE (f.actual_arrival - f.actual_departure) IS NOT NULL
-- ORDER BY 2 DESC
-- LIMIT 1

-- Вопрос 3. Между какими аэропортами пролегает самый длительный по времени запланированный рейс?

-- SELECT  distinct concat(departure_airport, ' - ',
--         arrival_airport),
--         extract(HOUR
--             FROM (f.scheduled_arrival - f.scheduled_departure))::real*3600.0 + extract(MINUTE
--                                                                                     FROM (f.scheduled_arrival - f.scheduled_departure))::real*60.0 +
--                                                                                                                                         extract(SECOND 
--                                                                                                                                                 FROM (f.scheduled_arrival - f.scheduled_departure))::real
-- FROM dst_project.flights f
-- ORDER BY 2 DESC

-- Вопрос 4. Сколько составляет средняя дальность полета среди всех самолетов в минутах? Секунды округляются в меньшую сторону (отбрасываются до минут).

-- SELECT round(avg(extract(HOUR
--                          FROM (f.actual_arrival - f.actual_departure))::real*60 + extract(MINUTE
--                                                                                           FROM (f.actual_arrival - f.actual_departure))::real))
-- FROM dst_project.flights f

-- ====================================================================
---------------------------Задание 4.5---------------------------------
-- Вопрос 1. Мест какого класса у SU9 больше всего?

-- SELECT 'Business' fare_condition,
--                   count(s.fare_conditions) Num_of_seats
-- FROM dst_project.seats s
-- WHERE s.aircraft_code = 'SU9'
--   AND s.fare_conditions = 'Business'
-- UNION ALL
-- SELECT 'Economy' fare_condition,
--                  count(s.fare_conditions) Num_of_seats
-- FROM dst_project.seats s
-- WHERE s.aircraft_code = 'SU9'
--   AND s.fare_conditions = 'Economy'
-- ORDER BY 2 DESC

-- Вопрос 2. Какую самую минимальную стоимость составило бронирование за всю историю?

-- SELECT min(b.total_amount)
-- FROM dst_project.bookings b

-- Вопрос 3. Какой номер места был у пассажира с id = 4313 788533?

-- SELECT b.seat_no
-- FROM dst_project.boarding_passes b
-- JOIN dst_project.tickets t ON b.ticket_no = t.ticket_no
-- WHERE t.passenger_id = '4313 788533'

-- ====================================================================
---------------------------Задание 5.1---------------------------------
-- Вопрос 1. Анапа — курортный город на юге России. Сколько рейсов прибыло в Анапу за 2017 год?

-- WITH flights_to_Anapa AS
--   (SELECT *
--   FROM dst_project.flights f
--   LEFT JOIN dst_project.airports a ON f.arrival_airport = a.airport_code
--   WHERE a.city = 'Anapa'),
  
--      flights_from_Anapa AS
--   (SELECT *
--   FROM dst_project.flights f
--   LEFT JOIN dst_project.airports a ON f.departure_airport = a.airport_code
--   WHERE a.city = 'Anapa')

-- SELECT count(f.actual_arrival)
-- FROM flights_to_Anapa f
-- WHERE extract(YEAR
--               FROM f.actual_arrival) = 2017

-- Вопрос 2. Сколько рейсов из Анапы вылетело зимой 2017 года?

-- SELECT count(f.actual_departure)
-- FROM flights_from_Anapa f
-- WHERE extract(YEAR
--           FROM f.actual_arrival) = 2017
-- AND extract(MONTH
--           FROM f.actual_arrival) in (12,
--                                      1,
--                                      2)

-- Вопрос 3. Посчитайте количество отмененных рейсов из Анапы за все время.

-- SELECT count(f.flight_id)
-- FROM flights_from_Anapa f
-- where f.status='Cancelled'

-- Вопрос 4. Сколько рейсов из Анапы не летают в Москву?

-- WITH flights_from_Anapa AS
--   (SELECT *
--   FROM dst_project.flights f
--   LEFT JOIN dst_project.airports a ON f.departure_airport = a.airport_code
--   WHERE a.city = 'Anapa')
   
-- SELECT count(f.flight_id)
-- FROM dst_project.flights f
-- LEFT JOIN dst_project.airports a ON f.arrival_airport = a.airport_code
-- WHERE a.city != 'Moscow'
--   AND f.departure_airport = 'AAQ' -- Сколько рейсов из Анапы в города, отличные от Москвы?

--   SELECT DISTINCT a.city,
--                   count(f.flight_id)
--   FROM dst_project.flights f
--   LEFT JOIN dst_project.airports a ON f.arrival_airport = a.airport_code WHERE a.city != 'Moscow'
--   AND f.departure_airport = 'AAQ'
-- GROUP BY 1

-- Вопрос 5. Какая модель самолета летящего на рейсах из Анапы имеет больше всего мест?

-- WITH aircraft_ext AS
--   (SELECT a.aircraft_code,
--           a.model,
--           a.range,
--           s.seat_no,
--           s.fare_conditions
--   FROM dst_project.aircrafts a
--   JOIN dst_project.seats s ON a.aircraft_code=s.aircraft_code)

-- SELECT model,
--       count(DISTINCT a.seat_no)
-- FROM dst_project.flights f
-- LEFT JOIN aircraft_ext a ON f.aircraft_code = a.aircraft_code
-- WHERE f.departure_airport = 'AAQ'
-- GROUP BY 1
-- ORDER BY 2 DESC

-- ====================================================================
---------------------------ЗАДАЧА ПРОЕКТА------------------------------

with flight_distance_from_Anapa as (
select
        'Москва' arrival_city,
        1208 flight_distance
union
select
        'Новокузнецк' arrival_city,
        3661 flight_distance
union
select
        'Белгород' arrival_city,
        636 flight_distance
        
), flight_duration_in_hr as (
select distinct fv.scheduled_duration flight_duration,
       extract (HOUR from fv.scheduled_duration)::real + extract (MINUTE from fv.scheduled_duration)::real / 60.0 flight_duration_in_hr
from dst_project.flights_v fv

), seats_sold as (
select 
        fv.flight_id,
        count(bp.seat_no) seats_sold
from dst_project.flights_v fv
        left join dst_project.boarding_passes bp on fv.flight_id = bp.flight_id
WHERE fv.departure_city = 'Анапа'
 AND (date_trunc('month', fv.scheduled_departure) in ('2017-01-01', '2017-02-01', '2017-12-01'))
 AND fv.status not in ('Cancelled')
group by 1
), gain_per_flight as (
select
        tf.flight_id flight_id,
        sum(tf.amount) gain_per_flight
from dst_project.ticket_flights tf
group by 1
)

SELECT fv.flight_id,                                                --#1
        fv.departure_city,                                          --#2
        fv.arrival_city,                                            --#3
        fv.scheduled_departure,                                     --#4
        fdm.flight_duration_in_hr,                                  --#5
        /*2*6371*asin(|/( sin( (radians(ap.latitude) - 0.79) / 2.0 ) ^ 2.0 + cos(radians(ap.latitude))*cos(0.79)*sin( (radians(ap.longitude) - 0.65) / 2.0) ^ 2.0)) flight_distance,*/
        fdfa.flight_distance,                                       --#6
        fdfa.flight_distance / fdm.flight_duration_in_hr avg_speed, --#7
        ac.model,                                                   --#8
        count(distinct seat_no) seats_in_a_plane,                   --#9
        ss.seats_sold seats_sold,                                   --#10
        gpf.gain_per_flight gain_per_flight                         --#11
FROM dst_project.flights_v fv
            left join dst_project.aircrafts ac on fv.aircraft_code = ac.aircraft_code
            left join dst_project.airports ap on fv.arrival_airport = ap.airport_code
            left join dst_project.seats s on fv.aircraft_code = s.aircraft_code
            /*left join dst_project.seats s on fv.aircraft_code = s.aircraft_code*/
            left join flight_distance_from_Anapa fdfa on fdfa.arrival_city = fv.arrival_city
            left join flight_duration_in_hr fdm on fv.scheduled_duration = fdm.flight_duration
            left join dst_project.ticket_flights tf on fv.flight_id = tf.flight_id
            left join seats_sold ss on fv.flight_id = ss.flight_id
            left join gain_per_flight gpf on fv.flight_id = gpf.flight_id
WHERE fv.departure_city = 'Анапа'
  AND (date_trunc('month', fv.scheduled_departure) in ('2017-01-01', '2017-02-01', '2017-12-01'))
 AND fv.status not in ('Cancelled')
--  and fv.flight_id in (136119, 136120, 136122)
group by 1, 2, 3, 4, 5, 6, 7, 8, 10, 11
  
-- select a.model, count(distinct seat_no) seats_in_a_plane
-- from dst_project.seats s join dst_project.aircrafts a on s.aircraft_code = a.aircraft_code
-- where a.model in ('Boeing 737-300', 'Sukhoi Superjet-100')
-- group by 1


-- select fv.actual_duration, fv.actual_arrival - fv.actual_departure
-- from dst_project.flights_v fv
-- WHERE fv.departure_airport = 'AAQ'
--   AND (date_trunc('month', fv.scheduled_departure) in ('2017-01-01', '2017-02-01', '2017-12-01'))
--   AND fv.status not in ('Cancelled')
-- ====================================================================
/*
                                    дата       руб./т
стоимость авиатоплива Анапа |январь  2017 г. | 41435
                            |февраль 2017 г. | 39553
                            |декабрь 2017 г. | 47101
                            
расход топлива |    кг/ч    |  г/пасс.- км
    SSJ-100    | 1700-1900  |     17-19
    B737-300   |    2400    |       26
*/
